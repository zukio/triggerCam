# マイク状態通知アプリ

このアプリは、Windows PC に接続されているマイクの ON/OFF/Mute 状態を検知し、その状態変化を別のプログラムへ UDP で通知するためのバックグラウンドアプリケーションです。また、外部アプリケーションからの命令を受け取り、マイクの操作や録音を行うことができます。

## ダウンロード

最新のリリース版は[こちら](https://github.com/あなたのGitHubユーザー名/リポジトリ名/releases/latest)からダウンロードできます。

ダウンロードした ZIP ファイルを解凍し、`micNotifyUDP.exe`を実行してください。

## バージョン（ブランチ）

- master: 公開ブランチ
- dev: 開発用／編集中の可能性があります【！】
- simple: 監視専用／マイク状態を監視し、変更時にUDPで通知
- control: マイク状態監視に加え、マイクの操作が可能
- control_post: マイク状態の監視・操作・録音に加え、録音データをAPIにポストする機能を追加
- control_ws: マイク状態の監視・操作に加え、Websocketによるストリーミング転送を実装

## 主な機能

### 1. 基本メニュー

アプリケーションを起動すると、タスクバーにアイコンが表示されます。このアイコンをクリックすると、以下のメニュー項目が展開します。

![Screenshot of the application](Assets/contextMenu.png)

![Screenshot of the application](Assets/trayIcon.png)

- **マイクリスト**: PC に接続されているマイクの一覧が表示されます。このアプリで監視するマイクを選択できます（システムのデフォルトマイクとは独立して動作します）。
- **マイク状態**: 選択中のマイクの接続（ON/OFF/Mute）状態を表示・変更します。
- **録音する／録音停止**
  - **録音レベル**: 録音時の無音判定閾値を設定できます。
  - **一時ファイルを使用する**: 一時ディレクトリにファイル保存
    - **録音データの保存場所**: 録音ファイルの保存場所を設定できます。
    - **録音データを開く**:  録音ファイルの保存場所をエクスプローラで開きます
- **UDP アドレス**: 通知先の UDP アドレスを設定できます。
- **変更して再起動ボタン**: 変更を保存します。
- **Exit ボタン**: アプリケーションを終了します。

注意：このアプリケーションで選択するマイクデバイスは、システムのデフォルトマイクデバイスとは独立して動作します。例えば、システムでヘッドセットのマイクをデフォルトとして使用しながら、このアプリでは別のUSBマイクの状態を監視するといった使い方ができます。

### 2. UDP 通信（状態通知）

オーディオの状態の変化を検知すると、以下のメッセージが UDP で送信されます。

- 接続: `Connected {deviceName}`
- 接続解除: `disConnected`
- Mute/Off: `isMute`
- ON: `ON`
- 監視デバイス変更: `Changed {deviceName}`
- 録音開始: `RecStart`
- 録音停止: `RecStop {recordedFilePath}`

### 3. 外部からのコマンド受信

外部アプリケーションからUDPを通じてコマンドを受信し、マイクの操作や録音を行うことができます。コマンドはJSON形式で送信します。

#### コマンド一覧

| コマンド | 説明 | パラメータ | レスポンス |
|---------|------|-----------|-----------|
| `exit` | アプリケーションを終了する | なし | `{"status":"success","message":"Application will exit"}` |
| `mic_on` | マイクをONにする | なし | `{"status":"success","message":"Microphone turned on"}` |
| `mic_mute` | マイクをミュートにする | なし | `{"status":"success","message":"Microphone muted"}` |
| `mic_status` | マイクの状態を取得する | なし | `{"status":"success","message":"Microphone is on/muted","data":{"isMuted":false/true}}` |
| `rec_start` | 録音を開始する | ファイル名と保存パス（省略可） | `{"status":"success","message":"Recording started","data":{"fileName":"ファイル名","path":"保存パス"}}` |
| `rec_stop` | 録音を停止する | なし | `{"status":"success","message":"Recording stopped","data":{"filePath":"録音ファイルのパス","isEmpty":false}}` |

#### エラーレスポンス

コマンド実行時にエラーが発生した場合、以下のような形式でエラー情報が返されます：

```json
{
  "status": "error",
  "message": "エラーの詳細メッセージ"
}
```

主なエラーケース：

- マイク操作失敗: デバイスへのアクセスエラーなど
- 録音開始失敗: ディスク容量不足、権限エラーなど
- 既に録音中: 録音開始コマンドを重複実行
- 録音していない: 録音停止コマンドを録音していない状態で実行
- 不正なコマンド: 未知のコマンドや不正なパラメータ

#### コマンド送信例

```json
{
  "command": "mic_on"
}
```

```json
{
  "command": "rec_start",
  "param": {
    "fileName": "recording_20250304",
    "path": "C:/CustomRecordings"
  }
}
```

```json
{
  "command": "rec_start",
  "param": "recording_20250304"  // ファイル名のみ指定（パスはデフォルト）
}
```

### 4. 録音機能

`rec_start`コマンドで録音を開始し、`rec_stop`コマンドで録音を停止できます。録音ファイルはWAV形式で保存され、以下の優先順位で保存場所が決定されます：

1. UDPのrec_startコマンドで指定されたパス
2. 起動時引数（/recordingsDir）で指定されたパス
3. 設定ファイルに保存された値
4. デフォルト値（実行パスのRecordingsフォルダ）

録音ファイル名は以下の方法で指定できます：

- `rec_start`コマンドの`fileName`パラメータで指定
- `rec_start`コマンドのパラメータを文字列で直接指定
- 省略時は現在の日時（yyyyMMdd_HHmmss形式）を使用

無音判定：

- 設定された閾値以下の音声レベルが続く場合、その部分は録音されません
- 閾値はUIのスライダーで調整可能
- 設定は保存され、次回起動時も維持されます

### 5. 起動時引数

アプリケーションの起動時に、以下の引数で監視対象のデバイス名や通信用のUDPアドレス、録音ファイルの保存場所を指定できます。

- `/deviceName="your-device-name"` - 監視対象のデバイス名
- `/udpTo="127.0.0.1:23456"` - 状態通知の送信先UDPアドレス
- `/udpListen="127.0.0.1:10001"` - コマンド受信用のUDPアドレス
- `/recordingsDir="C:/Recordings"` - 録音ファイルの保存場所

### 6. 多重起動制御

アプリケーションは多重起動を制御します。すでに起動中の場合、新たなインスタンスの起動は阻止されます。

### 7. ログ

実行 exe と同じディレクトリに、`ConsoleLogs`というディレクトリが自動で作成されます。アプリケーションの起動毎に、このディレクトリ内に日付をファイル名とするログファイルが作成され、各種情報やエラーメッセージが記録されます。

### 8. エラーハンドリング

アプリケーションは以下のような状況で適切なエラーハンドリングを実装しています：

- マイクデバイスの切断/再接続
- 録音ファイルの保存失敗
- UDPコマンドの不正な形式
- メモリリソースの管理
- ファイルシステムの操作エラー

エラーが発生した場合：

1. エラーログが記録されます
2. UDPコマンドの場合はエラーレスポンスが返されます
3. UIに適切なエラーメッセージが表示されます
4. 可能な場合は自動的にリカバリを試みます

### システム要件

- **オペレーティングシステム**: Windows
- **開発環境**: Visual Studio 2022
- **フレームワーク**: .NET Core, Windows Forms (WinForms)

## 開発者向け情報

このプロジェクトは Windows Forms（WinForms）アプリケーションとして開発されました。
WinFormsは、Windowsデスクトップアプリケーションを作成するための.NETフレームワークで、
特にシステムトレイアプリケーションの開発に適しています。

開発環境は Visual Studio 2022 です。

### インストール

1. プロジェクトをカスタマイズするには、このリポジトリをクローンまたはダウンロードします。
2. Visual Studio 2022 でプロジェクトを開きます。
3. 必要な依存関係や NuGet パッケージをインストールします。
   - NuGet パッケージ: NAudio
4. ビルドして実行します。

### 貢献

貢献は大歓迎です！バグ報告、新機能の提案など、どうぞお気軽に Issue を開いてください。
